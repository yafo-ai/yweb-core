---
description: 测试真实性与失败处置规则。编写/修改测试或处理 pytest 失败时自动应用，防止虚假测试并要求先诊断后改码。
globs: **/tests/**/*.py, **/test_*.py, yweb-core/TEST_DOCS.md, pytest.ini
alwaysApply: false
---

# 测试真实性与失败处置规则

## 1) 防止虚假测试

编写或修改测试时，必须主动规避以下反模式：

- 仅 Happy Path，不覆盖错误与边界
- 浅层断言，只看 `status_code` 不看错误语义
- 过度依赖实现细节（脆弱测试）
- Implementation-Driven / Puppet / Tautological（同源自证）

必须满足：

1. **规格驱动**：优先根据需求/契约设计测试，不根据源码细节反推
2. **独立真值**：断言来自可外部验证的结果（错误码、状态码、业务规则、持久化状态）
3. **关键反例**：每个核心行为至少包含一个失败场景

## 2) 测试失败时的强制流程

测试失败后，默认执行：

1. 复现并最小化问题
2. 输出问题分析（现象、复现、影响范围、证据）
3. 给出至少两个可选修复方案（改测试 / 改实现 / 补规格），并写明风险
4. 等待用户明确选择，再实施修改

禁止在未完成以上步骤前直接修改业务源码。

## 3) 关联 Skill（必读）

处理上述场景时，先阅读：

- `.cursor/skills/yweb-testing/SKILL.md`
- `.cursor/skills/yweb-test-quality/SKILL.md`
